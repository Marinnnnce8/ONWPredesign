var duration=NBkit.options.duration;UIkit.component("nbForm",{args:"msgConfirm",props:["msgConfirm"],data:{button:null,buttonText:"",captcha:null,response:"",scroller:null,status:0},beforeConnect:function(){nb.profilerStart("nbForm.beforeConnect");var t=this.$el,e=uk.$("input[type=hidden]._post_token",t);if(e){var r=function(t){uk.attr(e,"name",t.tokenName),uk.attr(e,"value",t.tokenValue)},n=nb.hasStorage?sessionStorage.getItem("CSRF"):"";if(n)try{r(JSON.parse(n))}catch(t){}else nb.graphql("{CSRF {tokenName tokenValue}}").then(function(t){200===t.status&&(n=t.response.CSRF,r(n),nb.hasStorage&&sessionStorage.setItem("CSRF",JSON.stringify(n)))},uk.noop)}this.scroller=uk.$(nb.attr({hidden:!0},"div",!0)),uk.append(t,this.scroller),nb.profilerStop("nbForm.beforeConnect")},connected:function(){nb.profilerStart("nbForm.connected");var t=this.$el;setTimeout(function(){uk.trigger(t,"onload",this),nb.profilerStop("nbForm.connected")},duration)},events:{submit:function(t){nb.profilerStart("nbForm.events.submit"),t.preventDefault(),t.stopPropagation();var e=this.$el,r=[],n=uk.$$(".nb-form-errors",e);if(n&&uk.remove(n),uk.$$("input[required], select[required], textarea[required]",e).forEach(function(t){uk.attr(t,"aria-invalid",!1),uk.remove(uk.$(".nb-form-error",t.closest(".nb-form-content")))}),uk.$$("input[required], select[required], textarea[required]",e).forEach(function(t){if(!t.validity.valid){uk.attr(t,"aria-invalid",!0);var n=uk.attr(t,"title");n||(n=t.validationMessage);var o=t.id,i=o?uk.$("label[for="+o+"]",e):null;n=nb.punctuateString(n),r.push(nb.link("#"+(o||e.id),(i?i.innerHTML+": ":"")+n,{class:"uk-link-reset",dataUkScroll:{duration:NBkit.options.speed,offset:NBkit.options.offset}}));var s=nb.wrap(n,"uk-text-danger nb-form-error"),a=uk.$("[role=alert]",t.closest(".nb-form-content"));a?uk.append(a,s):uk.before(t,s)}}),r.length)return uk.trigger(e,"invalid",this),this.reset(),uk.before(uk.$(".uk-grid",e),nb.ukAlert(nb.wrap(nb.wrap(r,"li"),"ul"),"danger",["nb-form-errors"])),UIkit.scroll(this.scroller,{duration:NBkit.options.speed,offset:NBkit.options.offset}).scrollTo(e),uk.on('.nb-form-errors a[href^="#"]',"click",function(){uk.$(uk.attr(this,"href")).focus()}),!1;if(this.button=uk.$("button[type=submit]",e),this.msgConfirm){var o=this;UIkit.modal.confirm(this.msgConfirm).then(function(){o.send()},function(){return!1})}else this.send();nb.profilerStop("nbForm.events.submit")}},methods:{complete:function(){var t=this.$el,e=this.response;if(uk.trigger(t,"complete",this),uk.isPlainObject(e)){var r=0;if(e.notification&&(nb.ukNotification(e.notification),r="timeout"in e.notification?e.notification.timeout:duration),"callback"in e){var n=e.callback,o=null;uk.isArray(n)&&(n=e.callback[0],o=e.callback[1]),n=n.split("."),uk.isUndefined(o)&&(o=null);for(var i=window[n[0]],s=1;s<n.length;s++)n[s]in i&&(i=i[n[s]]);if(i.apply(this,o),r=duration,!0===e.callback[2])return}if("redirect"in e)return e.redirect&&setTimeout(function(){uk.isString(e.redirect)?window.location.href=e.redirect:window.location.reload()},r),void this.reset();e=e.message}if(uk.remove(this.button),this.captcha&&uk.remove(this.captcha),uk.$$("input, select, textarea",t).forEach(function(t){uk.attr(t,"disabled",!0)}),e){var a=uk.$(".uk-grid",t);uk.before(a||t,nb.ukAlert(e,this.status)),UIkit.scroll(this.scroller,{duration:NBkit.options.speed,offset:NBkit.options.offset}).scrollTo(t)}},error:function(t,e){this.status=t,this.response=e,uk.trigger(this.$el,"error",this),uk.includes([401,412,500],t)?(this.reset(),UIkit.modal.alert(nb.ukAlert(e,"danger"))):this.complete()},reset:function(){this.button&&uk.html(this.button,this.buttonText),this.captcha&&grecaptcha.reset()},send:function(){nb.profilerStart("nbForm.send");var t=this.$el,e=uk.attr(t,"method");this.buttonText=uk.html(this.button),uk.html(this.button,nb.ukSpinner(.467)),this.captcha=uk.$(".g-recaptcha",t),uk.trigger(t,"beforeSend",this);var r=this;nb.ajax(t.action,{data:new FormData(t),method:e||"POST"}).then(function(t){r.status=t.status,r.response=t.response,t.response?r.complete():r.error(t.status,"Error"),nb.profilerStop("nbForm.send")},function(t){r.error(t.status,t.response),nb.profilerStop("nbForm.send")})}}});
