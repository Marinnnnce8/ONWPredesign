UIkit.component("nbJson",{args:"renderData",props:{config:Object,clsMore:String,clsMoreButton:String,error:String,form:String,loadMore:String,message:String,noResults:String,query:String,render:String,renderData:String,variables:Object},data:{count:0,config:{},clsMore:"uk-text-center uk-margin-large-top",clsMoreButton:"uk-button-primary",error:"Error",errors:[],form:null,init:0,initQuery:!1,items:[],loadMore:"More",message:"",noResults:"",query:"",remaining:0,render:"main.renderItems",renderData:"",response:{},selectors:"",start:0,status:0,total:0,variables:{}},beforeConnect:function(){nb.profilerStart("nbJson.beforeConnect");for(var t=["start","selectors"],e=0;e<t.length;e++){var r=t[e];this.variables[r]&&(this[r]=this.variables[r])}this.init=this.start,this.errors=[this.error],uk.includes(this.clsMore,"nb-json-more")||(this.clsMore+=" nb-json-more"),uk.includes(this.clsMoreButton,"uk-button-")&&!uk.includes(this.clsMoreButton,"uk-button ")&&(this.clsMoreButton+=" uk-button");var s=this;this.form&&uk.isUndefined(this._connected)&&uk.on(this.form,"submit reset",function(t){var e=[];if("submit"===t.type){t.preventDefault(),t.stopPropagation();for(var r=nb.formDataEntries(this),n=0;n<r.length;n++){var i=r[n][1];if(i){var o=r[n][0],a="=",u=nb.data(uk.$("[name="+o+"]",this),"json-selectors");if(uk.isPlainObject(u)&&!uk.isEmpty(u)){var l=u.values[i];for(var h in u.selectors)uk.hasOwn(u.selectors,h)&&e.push(h+l[u.selectors[h]])}else uk.includes(o,a)&&(a=""),e.push(o+a+i)}}}s.get(e.join(","))});var n=uk.$$("[data-json-filter]");n.length&&uk.on(n,"click",function(t){t.preventDefault();var e=uk.data(this,"json-filter");uk.removeClass(n,"uk-active"),e&&uk.addClass(this,"uk-active"),s.get(e)}),nb.profilerStop("nbJson.beforeConnect")},connected:function(){nb.profilerStart("nbJson.connected");var t=this.$el,e=this;if(uk.on(t,"error",function(){uk.html(t,nb.ukAlert(e.errors,e.status))}),this.renderData)this.response=nb.base64_decode(this.renderData),this.parse(),this.count&&(uk.html(t,this.renderItems()),uk.trigger(t,"render",this),uk.trigger(t,"complete",this)),uk.removeAttr(t,"data-"+this.$name),this.$destroy();else{var r=0;if(this.form)for(var s=uk.$$("input, select, textarea",uk.$(this.form)),n=0;n<s.length;n++)s[n].value&&r++;r?uk.trigger(e.form,"submit"):this.request()}nb.profilerStop("nbJson.connected")},events:[{name:"click",delegate:function(){return".nb-json-more button"},handler:function(){this.request()}}],methods:{get:function(t){t=[t],this.selectors&&t.push(this.selectors),this.initQuery=!1,this.start=this.init,this.total=0,this.variables.selectors=t.join(","),this.variables.start=this.start,uk.html(this.$el,""),this.request()},parse:function(){for(var t in this.response)if(uk.hasOwn(this.response,t)){var e=this.response[t];if(uk.isArray(e)?(this.config.query=t,this.items=e,this.count=e.length):"getTotal"===t&&(this.total=e),this.count&&this.total)break}},renderItems:function(t){void 0===t&&(t=this.items);var e=window;if(uk.includes(this.render,"."))for(var r=this.render.split("."),s=0;s<r.length;s++)e=e[r[s]];else e=e[this.render];return uk.isFunction(e)&&uk.isArray(t)?e.call(this,t,this.config):(this.status=500,"")},request:function(){nb.profilerStart("nbJson.request");var t=this.$el,e=uk.$(".nb-json-more",t);this.count=0,this.remaining=0,uk.remove(".uk-alert",t),e||(e=uk.$(nb.wrap(nb.wrap(this.loadMore,{type:"button",class:this.clsMoreButton},"button"),this.clsMore)),uk.append(t,e)),e.style.display="";var r=uk.$("button",e);uk.attr(r,"disabled",!0),uk.html(r,uk.html(r).replace(this.loadMore,nb.ukSpinner(.467))),this.variables.start=this.start,this.initQuery||(this.initQuery=!0,uk.trigger(t,"initQuery",this));var s=this;nb.graphql(this.query,this.variables).then(function(n){if(s.status=n.status,s.response=n.response,s.response){uk.removeAttr(r,"disabled");var i=uk.$(".uk-spinner",r);if(i&&(uk.before(i,s.loadMore),uk.remove(i)),s.parse(),s.remaining=s.total?s.total-s.start-s.count:-1,s.message){var o=uk.$(".nb-json-message",t);o||(o=uk.$(nb.wrap("","nb-json-message uk-margin-top uk-margin-bottom")),uk.prepend(t,o));var a=s.message.replace("{count}",s.count+s.start-s.init).replace("{total}",s.total-s.init);uk.html(o,"jsonMessage"in window?jsonMessage(a):nb.ukAlert(a,"primary"))}s.count?(uk.before(e,s.renderItems()),uk.trigger(t,"render",s)):(s.errors=[s.noResults],s.status=404,uk.trigger(t,"error",s)),s.remaining<=0||!s.count||!s.loadMore?e.style.display="none":s.start=s.start+s.count,uk.trigger(t,"complete",s)}else uk.trigger(t,"error",s);nb.profilerStop("nbJson.request")},function(e){s.status=e.status,s.errors=e.response,uk.trigger(t,"error",s),nb.profilerStop("nbJson.request")})}}});
